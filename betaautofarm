local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local VirtualUser = game:GetService("VirtualUser")
local Lighting = game:GetService("Lighting")

local player = Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local rootPart = character:WaitForChild("HumanoidRootPart")

local antiFlingEnabled = false
local isActive, antiAfkEnabled, autoResetEnabled, effectsEnabled = false, false, false, false
local flySpeed, collected = 15, 0
local startTime = 0
local visitedPositions = {}

local ToDisable = {Textures = true, VisualEffects = true, Parts = true, Particles = true, Sky = true}
local ToEnable = {FullBright = false}
local DisabledItems = {}

local function processDescendant(v)
    if ToDisable.Parts and (v:IsA("Part") or v:IsA("Union") or v:IsA("BasePart")) then v.Material = Enum.Material.SmoothPlastic table.insert(DisabledItems, v) end
    if ToDisable.Particles and (v:IsA("ParticleEmitter") or v:IsA("Smoke") or v:IsA("Explosion") or v:IsA("Sparkles") or v:IsA("Fire")) then v.Enabled = false table.insert(DisabledItems, v) end
    if ToDisable.VisualEffects and (v:IsA("BloomEffect") or v:IsA("BlurEffect") or v:IsA("DepthOfFieldEffect") or v:IsA("SunRaysEffect")) then v.Enabled = false table.insert(DisabledItems, v) end
    if ToDisable.Textures and (v:IsA("Decal") or v:IsA("Texture")) then v.Texture = "" table.insert(DisabledItems, v) end
    if ToDisable.Sky and v:IsA("Sky") then v.Parent = nil table.insert(DisabledItems, v) end
end

local effectsLoop
local function toggleEffects()
    effectsEnabled = not effectsEnabled
    if effectsEnabled then
        DisabledItems = {}
        for _, v in ipairs(game:GetDescendants()) do processDescendant(v) end
        if ToEnable.FullBright then
            local white = Color3.fromRGB(255,255,255)
            Lighting.FogColor = white
            Lighting.FogStart = math.huge
            Lighting.FogEnd = math.huge
            Lighting.Ambient = white
            Lighting.Brightness = 5
            Lighting.ColorShift_Bottom = white
            Lighting.ColorShift_Top = white
            Lighting.OutdoorAmbient = white
            Lighting.Outlines = true
        end
        effectsLoop = task.spawn(function()
            while effectsEnabled do
                task.wait(15)
                for _, v in ipairs(game:GetDescendants()) do processDescendant(v) end
            end
        end)
    else
        if effectsLoop then
            effectsLoop:Cancel()
            effectsLoop = nil
        end
    end
end

RunService.Stepped:Connect(function()
    if antiFlingEnabled then
        for _, CoPlayer in pairs(Players:GetChildren()) do
            if CoPlayer ~= player and CoPlayer.Character then
                local hrp = CoPlayer.Character:FindFirstChild("HumanoidRootPart")
                if hrp then hrp.CanCollide = false end
            end
        end
        for _, acc in pairs(workspace:GetChildren()) do
            if acc:IsA("Accessory") then
                local part = acc:FindFirstChildWhichIsA("Part")
                if part then part:Destroy() end
            end
        end
    end
end)

player.CharacterAdded:Connect(function(char)
    character = char
    rootPart = char:WaitForChild("HumanoidRootPart")
    visitedPositions = {}
end)

local gui = Instance.new("ScreenGui", player:WaitForChild("PlayerGui"))
gui.Name = "AutoFarmGui"
gui.ResetOnSpawn = false

local frame = Instance.new("Frame", gui)
frame.Size = UDim2.new(0,220,0,300)
frame.Position = UDim2.new(0.5,-110,0.3,0)
frame.BackgroundColor3 = Color3.fromRGB(25,25,35)
frame.BorderSizePixel = 0
frame.Active, frame.Draggable = true, true
Instance.new("UICorner", frame).CornerRadius = UDim.new(0,12)
Instance.new("UIStroke", frame).Color = Color3.fromRGB(255,140,0)
frame.UIStroke.Thickness = 2

local function makeLabel(y,text)
    local lbl = Instance.new("TextLabel",frame)
    lbl.Size = UDim2.new(0,200,0,18)
    lbl.Position = UDim2.new(0.5,-100,0,y)
    lbl.Text = text
    lbl.TextColor3 = Color3.fromRGB(255,140,0)
    lbl.BackgroundTransparency = 1
    lbl.Font = Enum.Font.Gotham
    lbl.TextSize = 12
    lbl.TextXAlignment = Enum.TextXAlignment.Left
    return lbl
end

local function makeButton(y,text)
    local btn = Instance.new("TextButton",frame)
    btn.Size = UDim2.new(0,200,0,24)
    btn.Position = UDim2.new(0.5,-100,0,y)
    btn.Text = text
    btn.BackgroundColor3 = Color3.fromRGB(50,30,70)
    btn.TextColor3 = Color3.fromRGB(255,165,0)
    btn.Font = Enum.Font.GothamBold
    btn.TextSize = 12
    Instance.new("UICorner",btn).CornerRadius = UDim.new(0,6)
    btn.MouseEnter:Connect(function() TweenService:Create(btn,TweenInfo.new(0.2),{BackgroundColor3=Color3.fromRGB(120,60,180)}):Play() end)
    btn.MouseLeave:Connect(function() TweenService:Create(btn,TweenInfo.new(0.2),{BackgroundColor3=Color3.fromRGB(50,30,70)}):Play() end)
    return btn
end

local title = Instance.new("TextLabel",frame)
title.Size = UDim2.new(1,-12,0,28)
title.Position = UDim2.new(0,6,0,5)
title.Text = "ðŸŽƒ Fray.rbx || Autofarm"
title.TextColor3 = Color3.fromRGB(255,165,0)
title.BackgroundTransparency = 1
title.Font = Enum.Font.GothamBold
title.TextSize = 16
title.TextXAlignment = Enum.TextXAlignment.Left

local sep = Instance.new("Frame",frame)
sep.Size = UDim2.new(1,-12,0,1)
sep.Position = UDim2.new(0,6,0,35)
sep.BackgroundColor3 = Color3.fromRGB(120,60,180)
sep.BorderSizePixel = 0

local buttonY = 45
local function nextY() buttonY+=30 return buttonY end

local toggleBtn = makeButton(nextY(),"Auto: OFF")
local antiAfkBtn = makeButton(nextY(),"AFK: OFF")
local autoResetBtn = makeButton(nextY(),"AutoReset: OFF")
local speedBtn = makeButton(nextY(),"Speed: 15")
local antiFlingBtn = makeButton(nextY(),"Anti Fling: OFF")
local effectsBtn = makeButton(nextY(),"Effects: OFF")

local counterLabel = makeLabel(nextY(),"Candies: 0")
local timerLabel = makeLabel(nextY(),"Time: 0s")
local rateLabel = makeLabel(nextY(),"Rate: 0/h")

local function flyTo(pos,speed)
    if not rootPart or not rootPart.Parent then return end
    local dist = (pos-rootPart.Position).Magnitude
    local tween = TweenService:Create(rootPart,TweenInfo.new(dist/speed,Enum.EasingStyle.Linear),{CFrame=CFrame.new(pos)})
    tween:Play()
    tween.Completed:Wait()
end

toggleBtn.MouseButton1Click:Connect(function()
    isActive = not isActive
    toggleBtn.Text = isActive and "Auto: ON" or "Auto: OFF"
    toggleBtn.BackgroundColor3 = isActive and Color3.fromRGB(60,150,60) or Color3.fromRGB(50,30,70)
    if not isActive then return end
    collected,startTime,visitedPositions = 0,tick(),{}
    task.spawn(function()
        while isActive do
            local elapsed = tick()-startTime
            timerLabel.Text = "Time: "..math.floor(elapsed).."s"
            local rate = elapsed>0 and math.floor((collected/elapsed)*3600) or 0
            rateLabel.Text = "Rate: "..rate.."/h"
            task.wait(0.1)
        end
    end)
    task.spawn(function()
        while isActive do
            character = player.Character or player.CharacterAdded:Wait()
            rootPart = character:FindFirstChild("HumanoidRootPart")
            if rootPart then
                local closest,dist = nil,math.huge
                for _,obj in ipairs(workspace:GetDescendants()) do
                    if obj:IsA("BasePart") and obj.Name=="Coin_Server" and not visitedPositions[obj] then
                        local d = (obj.Position-rootPart.Position).Magnitude
                        if d<dist and d<250 then closest,dist = obj,d end
                    end
                end
                if closest then
                    flyTo(closest.Position,flySpeed)
                    if closest:IsDescendantOf(workspace) then
                        visitedPositions[closest]=true
                        collected+=1
                        counterLabel.Text="Candies: "..collected
                    end
                end
            end
            if autoResetEnabled and character then
                local mainGui = player:FindFirstChild("PlayerGui") and player.PlayerGui:FindFirstChild("MainGUI")
                local gameGui = mainGui and mainGui:FindFirstChild("Game")
                local coinBags = gameGui and gameGui:FindFirstChild("CoinBags")
                local container = coinBags and coinBags:FindFirstChild("Container")
                local candy = container and container:FindFirstChild("Candy")
                local currencyFrame = candy and candy:FindFirstChild("CurrencyFrame")
                local icon = currencyFrame and currencyFrame:FindFirstChild("Icon")
                local coinTextLabel = icon and icon:FindFirstChild("Coins")
                if coinTextLabel then
                    local coins = tonumber(coinTextLabel.Text)
                    if coins and coins>=40 then character:BreakJoints() end
                end
            end
            task.wait(0.1)
        end
    end)
end)

antiAfkBtn.MouseButton1Click:Connect(function()
    antiAfkEnabled = not antiAfkEnabled
    antiAfkBtn.Text = antiAfkEnabled and "AFK: ON" or "AFK: OFF"
end)

autoResetBtn.MouseButton1Click:Connect(function()
    autoResetEnabled = not autoResetEnabled
    autoResetBtn.Text = autoResetEnabled and "AutoReset: ON" or "AutoReset: OFF"
end)

speedBtn.MouseButton1Click:Connect(function()
    flySpeed += 1
    if flySpeed>25 then flySpeed=10 end
    speedBtn.Text = "Speed: "..flySpeed
end)

antiFlingBtn.MouseButton1Click:Connect(function()
    antiFlingEnabled = not antiFlingEnabled
    antiFlingBtn.Text = antiFlingEnabled and "Anti Fling: ON" or "Anti Fling: OFF"
end)

effectsBtn.MouseButton1Click:Connect(function()
    toggleEffects()
end)

player.Idled:Connect(function()
    if antiAfkEnabled then
        task.spawn(function()
            VirtualUser:Button2Down(Vector2.new(0,0),workspace.CurrentCamera.CFrame)
            task.wait(1)
            VirtualUser:Button2Up(Vector2.new(0,0),workspace.CurrentCamera.CFrame)
        end)
    end
end)
