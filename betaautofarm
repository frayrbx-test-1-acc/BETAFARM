local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local VirtualUser = game:GetService("VirtualUser")

local player = Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local rootPart = character:WaitForChild("HumanoidRootPart")

local antiFlingEnabled = false
local visitedPositions, isActive, flySpeed, collected = {}, false, 15, 0
local startTime, antiAfkEnabled, autoResetEnabled = 0, false, false
local texturesHidden = false

-- ÐŸÐ¾Ð´ÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ÑÑ Ðº ÑÐ¼ÐµÐ½Ðµ Ð¿ÐµÑ€ÑÐ¾Ð½Ð°Ð¶Ð°
player.CharacterAdded:Connect(function(char)
	character = char
	rootPart = char:WaitForChild("HumanoidRootPart")
	visitedPositions = {}
end)

-- GUI
local gui = Instance.new("ScreenGui")
gui.Name = "AutoFarmGui"
gui.ResetOnSpawn = false
gui.Parent = player:WaitForChild("PlayerGui")

local frame = Instance.new("Frame", gui)
frame.Size = UDim2.new(0, 220, 0, 360)
frame.Position = UDim2.new(0.5, -110, 0.3, 0)
frame.BackgroundColor3 = Color3.fromRGB(25,25,35)
frame.BorderSizePixel = 0
frame.Active, frame.Draggable = true, true
Instance.new("UICorner", frame).CornerRadius = UDim.new(0,12)
local stroke = Instance.new("UIStroke", frame)
stroke.Color, stroke.Thickness = Color3.fromRGB(255,140,0), 2

-- Ð’ÑÐ¿Ð¾Ð¼Ð¾Ð³Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¸
local function makeLabel(y, text)
	local lbl = Instance.new("TextLabel", frame)
	lbl.Size = UDim2.new(0,200,0,18)
	lbl.Position = UDim2.new(0.5,-100,0,y)
	lbl.Text = text
	lbl.TextColor3 = Color3.fromRGB(255,140,0)
	lbl.BackgroundTransparency = 1
	lbl.Font = Enum.Font.Gotham
	lbl.TextSize = 12
	lbl.TextXAlignment = Enum.TextXAlignment.Left
	return lbl
end

local function makeButton(y, text)
	local btn = Instance.new("TextButton", frame)
	btn.Size = UDim2.new(0,200,0,24)
	btn.Position = UDim2.new(0.5,-100,0,y)
	btn.Text = text
	btn.BackgroundColor3 = Color3.fromRGB(50,30,70)
	btn.TextColor3 = Color3.fromRGB(255,165,0)
	btn.Font = Enum.Font.GothamBold
	btn.TextSize = 12
	Instance.new("UICorner", btn).CornerRadius = UDim.new(0,6)
	btn.MouseEnter:Connect(function()
		TweenService:Create(btn, TweenInfo.new(0.2), {BackgroundColor3=Color3.fromRGB(120,60,180)}):Play()
	end)
	btn.MouseLeave:Connect(function()
		TweenService:Create(btn, TweenInfo.new(0.2), {BackgroundColor3=Color3.fromRGB(50,30,70)}):Play()
	end)
	return btn
end

-- Ð—Ð°Ð³Ð¾Ð»Ð¾Ð²Ð¾Ðº
local title = Instance.new("TextLabel", frame)
title.Size = UDim2.new(1,-12,0,28)
title.Position = UDim2.new(0,6,0,5)
title.Text = "ðŸŽƒ Fray.rbx || Autofarm"
title.TextColor3 = Color3.fromRGB(255,165,0)
title.BackgroundTransparency = 1
title.Font = Enum.Font.GothamBold
title.TextSize = 16
title.TextXAlignment = Enum.TextXAlignment.Left

local sep = Instance.new("Frame", frame)
sep.Size = UDim2.new(1,-12,0,1)
sep.Position = UDim2.new(0,6,0,35)
sep.BackgroundColor3 = Color3.fromRGB(120,60,180)
sep.BorderSizePixel = 0

-- ÐšÐ½Ð¾Ð¿ÐºÐ¸
local toggleBtn = makeButton(50, "Auto: OFF")
local antiAfkBtn = makeButton(85, "AFK: OFF")
local autoResetBtn = makeButton(120, "AutoReset: OFF")
local speedBtn = makeButton(155, "Speed: 15")
local antiFlingBtn = makeButton(190, "Anti Fling: OFF")
local texturesBtn = makeButton(225, "Hide Textures: OFF")

-- Ð›ÐµÐ¹Ð±Ð»Ñ‹
local counterLabel = makeLabel(260, "Candies: 0")
local timerLabel = makeLabel(275, "Time: 0s")
local rateLabel = makeLabel(290, "Rate: 0/h")

-- ÐŸÐµÑ€ÐµÐ¼ÐµÑ‰ÐµÐ½Ð¸Ðµ
local function flyTo(pos, speed)
	if not rootPart or not rootPart.Parent then return end
	local dist = (pos - rootPart.Position).Magnitude
	local tween = TweenService:Create(rootPart, TweenInfo.new(dist/speed, Enum.EasingStyle.Linear), {CFrame=CFrame.new(pos)})
	tween:Play()
	tween.Completed:Wait()
end

-- Hide textures
texturesBtn.MouseButton1Click:Connect(function()
	texturesHidden = not texturesHidden
	for _, obj in pairs(workspace:GetDescendants()) do
		if obj:IsA("Decal") or obj:IsA("Texture") then
			obj.Transparency = texturesHidden and 1 or 0
		end
	end
	texturesBtn.Text = texturesHidden and "Hide Textures: ON âœ…" or "Hide Textures: OFF"
end)

-- Anti-Fling
RunService.Stepped:Connect(function()
	if antiFlingEnabled then
		for _, coPlayer in pairs(Players:GetPlayers()) do
			if coPlayer ~= player and coPlayer.Character then
				local hrp = coPlayer.Character:FindFirstChild("HumanoidRootPart")
				if hrp then hrp.CanCollide = false end
			end
		end
	end
end)

-- ÐžÑÐ½Ð¾Ð²Ð½Ð°Ñ Ð»Ð¾Ð³Ð¸ÐºÐ° Ð°Ð²Ñ‚Ð¾ÑÐ±Ð¾Ñ€Ð°
toggleBtn.MouseButton1Click:Connect(function()
	isActive = not isActive
	toggleBtn.Text = isActive and "Auto: ON" or "Auto: OFF"
	toggleBtn.BackgroundColor3 = isActive and Color3.fromRGB(60,150,60) or Color3.fromRGB(50,30,70)
	if not isActive then return end

	collected, startTime, visitedPositions = 0, tick(), {}

	task.spawn(function()
		while isActive do
			local elapsed = tick() - startTime
			timerLabel.Text = "Time: "..math.floor(elapsed).."s"
			local rate = elapsed > 0 and math.floor((collected/elapsed)*3600) or 0
			rateLabel.Text = "Rate: "..rate.."/h"
			task.wait(0.1)
		end
	end)

	task.spawn(function()
		while isActive do
			character = player.Character or player.CharacterAdded:Wait()
			rootPart = character:FindFirstChild("HumanoidRootPart")
			if rootPart then
				local closest, dist = nil, math.huge
				for _, obj in ipairs(workspace:GetDescendants()) do
					if obj:IsA("BasePart") and obj.Name=="Coin_Server" and not visitedPositions[obj] then
						local d = (obj.Position - rootPart.Position).Magnitude
						if d < dist and d < 250 then
							closest, dist = obj, d
						end
					end
				end
				if closest then
					flyTo(closest.Position, flySpeed)
					if closest:IsDescendantOf(workspace) then
						visitedPositions[closest] = true
						collected += 1
						counterLabel.Text = "Candies: "..collected
					end
				end
			end

			if autoResetEnabled and character then
				local mainGui = player:FindFirstChild("PlayerGui") and player.PlayerGui:FindFirstChild("MainGUI")
				local gameGui = mainGui and mainGui:FindFirstChild("Game")
				local coinBags = gameGui and gameGui:FindFirstChild("CoinBags")
				local container = coinBags and coinBags:FindFirstChild("Container")
				local candy = container and container:FindFirstChild("Candy")
				local currencyFrame = candy and candy:FindFirstChild("CurrencyFrame")
				local icon = currencyFrame and currencyFrame:FindFirstChild("Icon")
				local coinTextLabel = icon and icon:FindFirstChild("Coins")
				if coinTextLabel then
					local coins = tonumber(coinTextLabel.Text)
					if coins and coins >= 40 then
						character:BreakJoints()
					end
				end
			end

			task.wait(0.1)
		end
	end)
end)

-- ÐžÑÑ‚Ð°Ð»ÑŒÐ½Ñ‹Ðµ ÐºÐ½Ð¾Ð¿ÐºÐ¸
antiAfkBtn.MouseButton1Click:Connect(function()
	antiAfkEnabled = not antiAfkEnabled
	antiAfkBtn.Text = antiAfkEnabled and "AFK: ON" or "AFK: OFF"
end)

autoResetBtn.MouseButton1Click:Connect(function()
	autoResetEnabled = not autoResetEnabled
	autoResetBtn.Text = autoResetEnabled and "AutoReset: ON" or "AutoReset: OFF"
end)

speedBtn.MouseButton1Click:Connect(function()
	flySpeed += 1
	if flySpeed > 25 then flySpeed = 10 end
	speedBtn.Text = "Speed: "..flySpeed
end)

antiFlingBtn.MouseButton1Click:Connect(function()
	antiFlingEnabled = not antiFlingEnabled
	antiFlingBtn.Text = antiFlingEnabled and "Anti Fling: ON" or "Anti Fling: OFF"
end)

player.Idled:Connect(function()
	if antiAfkEnabled then
		task.spawn(function()
			VirtualUser:Button2Down(Vector2.new(0,0),workspace.CurrentCamera.CFrame)
			task.wait(1)
			VirtualUser:Button2Up(Vector2.new(0,0),workspace.CurrentCamera.CFrame)
		end)
	end
end)
