local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local VirtualUser = game:GetService("VirtualUser")

local player = Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local rootPart = character:WaitForChild("HumanoidRootPart")

local antiFlingEnabled = false

local function disableCollisions()
	for _, part in pairs(character:GetChildren()) do
		if part:IsA("BasePart") then
			part.CanCollide = false
		end
	end
end

disableCollisions()
player.CharacterAdded:Connect(function(char)
	character = char
	rootPart = char:WaitForChild("HumanoidRootPart")
	disableCollisions()
end)

RunService.Stepped:Connect(function()
	if antiFlingEnabled then
		for _, CoPlayer in pairs(Players:GetChildren()) do
			if CoPlayer ~= player and CoPlayer.Character then
				local hrp = CoPlayer.Character:FindFirstChild("HumanoidRootPart")
				if hrp then hrp.CanCollide = false end
			end
		end
		for _, acc in pairs(workspace:GetChildren()) do
			if acc:IsA("Accessory") then
				local part = acc:FindFirstChildWhichIsA("Part")
				if part then part:Destroy() end
			end
		end
	end
end)

local visitedPositions, isActive, flySpeed, collected = {}, false, 15, 0
local startTime, antiAfkEnabled, autoResetEnabled = 0, false, false

player.CharacterAdded:Connect(function(char)
	character = char
	rootPart = char:WaitForChild("HumanoidRootPart")
	visitedPositions = {}
end)

local gui = Instance.new("ScreenGui", player:WaitForChild("PlayerGui"))
gui.Name = "AutoFarmGui"
gui.ResetOnSpawn = false

local frame = Instance.new("Frame", gui)
frame.Size = UDim2.new(0, 200, 0, 275)
frame.Position = UDim2.new(0.5, -96, 0.3, 0)
frame.BackgroundColor3 = Color3.fromRGB(25,25,35)
frame.BorderSizePixel = 0
frame.Active, frame.Draggable = true, true
Instance.new("UICorner", frame).CornerRadius = UDim.new(0,12)
local stroke = Instance.new("UIStroke", frame)
stroke.Color, stroke.Thickness = Color3.fromRGB(255,140,0), 2

local function makeLabel(y, text)
	local lbl = Instance.new("TextLabel", frame)
	lbl.Size = UDim2.new(0,160,0,18)
	lbl.Position = UDim2.new(0.5,-80,0,y)
	lbl.Text, lbl.TextColor3 = text, Color3.fromRGB(255,140,0)
	lbl.BackgroundTransparency = 1
	lbl.Font, lbl.TextSize, lbl.TextXAlignment = Enum.Font.Gotham, 12, Enum.TextXAlignment.Left
	return lbl
end

local function makeButton(y, text)
	local btn = Instance.new("TextButton", frame)
	btn.Size = UDim2.new(0,160,0,24)
	btn.Position = UDim2.new(0.5,-80,0,y)
	btn.Text = text
	btn.BackgroundColor3 = Color3.fromRGB(50,30,70)
	btn.TextColor3 = Color3.fromRGB(255,165,0)
	btn.Font, btn.TextSize = Enum.Font.GothamBold, 12
	Instance.new("UICorner", btn).CornerRadius = UDim.new(0,6)
	btn.MouseEnter:Connect(function()
		TweenService:Create(btn, TweenInfo.new(0.2), {BackgroundColor3=Color3.fromRGB(120,60,180)}):Play()
	end)
	btn.MouseLeave:Connect(function()
		TweenService:Create(btn, TweenInfo.new(0.2), {BackgroundColor3=Color3.fromRGB(50,30,70)}):Play()
	end)
	return btn
end

local title = Instance.new("TextLabel", frame)
title.Size = UDim2.new(1,-12,0,28)
title.Position = UDim2.new(0,6,0,5)
title.Text = "ðŸŽƒ Fray.rbx || Autofarm"
title.TextColor3, title.BackgroundTransparency = Color3.fromRGB(255,165,0), 1
title.Font, title.TextSize, title.TextXAlignment = Enum.Font.GothamBold, 16, Enum.TextXAlignment.Left

local sep = Instance.new("Frame", frame)
sep.Size = UDim2.new(1,-12,0,1)
sep.Position = UDim2.new(0,6,0,35)
sep.BackgroundColor3, sep.BorderSizePixel = Color3.fromRGB(120,60,180), 0

local toggleBtn = makeButton(45, "Auto: OFF")
local antiAfkBtn = makeButton(80, "AFK: OFF")
local autoResetBtn = makeButton(115, "AutoReset: OFF")
local speedBtn = makeButton(150, "Speed: 15")
local antiFlingBtn = makeButton(185, "Anti Fling: OFF")

local counterLabel = makeLabel(215, "Candies: 0")
local timerLabel = makeLabel(230, "Time: 0s")
local rateLabel = makeLabel(245, "Rate: 0/h")

local function flyTo(pos, speed)
	if not rootPart or not rootPart.Parent then return end
	local dt = 0.03
	while (pos - rootPart.Position).Magnitude > 1 do
		if not rootPart or not rootPart.Parent then break end
		local direction = (pos - rootPart.Position)
		local move = direction.Unit * math.min(direction.Magnitude, speed * dt)
		rootPart.CFrame = rootPart.CFrame + move
		RunService.Heartbeat:Wait()
	end
end

toggleBtn.MouseButton1Click:Connect(function()
	isActive = not isActive
	toggleBtn.Text = isActive and "Auto: ON" or "Auto: OFF"
	toggleBtn.BackgroundColor3 = isActive and Color3.fromRGB(60,150,60) or Color3.fromRGB(50,30,70)
	if not isActive then return end
	collected, startTime, visitedPositions = 0, tick(), {}
	task.spawn(function()
		while isActive do
			local elapsed = tick()-startTime
			timerLabel.Text = "Time: "..math.floor(elapsed).."s"
			local rate = elapsed>0 and math.floor((collected/elapsed)*3600) or 0
			rateLabel.Text = "Rate: "..rate.."/h"
			task.wait(0.1)
		end
	end)
	task.spawn(function()
		while isActive do
			character = player.Character or player.CharacterAdded:Wait()
			rootPart = character:FindFirstChild("HumanoidRootPart")
			if rootPart then
				local closest, dist = nil, math.huge
				for _, obj in ipairs(workspace:GetDescendants()) do
					if obj:IsA("BasePart") and obj.Name=="Coin_Server" and not visitedPositions[obj] then
						local d = (obj.Position-rootPart.Position).Magnitude
						if d<dist and d<250 then closest, dist = obj, d end
					end
				end
				if closest then
					flyTo(closest.Position, flySpeed)
					if closest:IsDescendantOf(workspace) then
						visitedPositions[closest]=true
						collected+=1
						counterLabel.Text="Candies: "..collected
					end
				end
			end
			if autoResetEnabled and character then
				local mainGui = player:FindFirstChild("PlayerGui") and player.PlayerGui:FindFirstChild("MainGUI")
				local gameGui = mainGui and mainGui:FindFirstChild("Game")
				local coinBags = gameGui and gameGui:FindFirstChild("CoinBags")
				local container = coinBags and coinBags:FindFirstChild("Container")
				local candy = container and container:FindFirstChild("Candy")
				local currencyFrame = candy and candy:FindFirstChild("CurrencyFrame")
				local icon = currencyFrame and currencyFrame:FindFirstChild("Icon")
				local coinTextLabel = icon and icon:FindFirstChild("Coins")
				if coinTextLabel then
					local coins = tonumber(coinTextLabel.Text)
					if coins and coins >= 40 then
						character:BreakJoints()
					end
				end
			end
			task.wait(0.03)
		end
	end)
end)

antiAfkBtn.MouseButton1Click:Connect(function()
	antiAfkEnabled = not antiAfkEnabled
	antiAfkBtn.Text = antiAfkEnabled and "AFK: ON" or "AFK: OFF"
end)

autoResetBtn.MouseButton1Click:Connect(function()
	autoResetEnabled = not autoResetEnabled
	autoResetBtn.Text = autoResetEnabled and "AutoReset: ON" or "AutoReset: OFF"
end)

speedBtn.MouseButton1Click:Connect(function()
	flySpeed += 1
	if flySpeed > 25 then flySpeed = 10 end
	speedBtn.Text = "Speed: "..flySpeed
end)

antiFlingBtn.MouseButton1Click:Connect(function()
	antiFlingEnabled = not antiFlingEnabled
	antiFlingBtn.Text = antiFlingEnabled and "Anti Fling: ON" or "Anti Fling: OFF"
end)

player.Idled:Connect(function()
	if antiAfkEnabled then
		task.spawn(function()
			VirtualUser:Button2Down(Vector2.new(0,0),workspace.CurrentCamera.CFrame)
			task.wait(1)
			VirtualUser:Button2Up(Vector2.new(0,0),workspace.CurrentCamera.CFrame)
		end)
	end
end)
