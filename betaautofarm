-- LocalScript

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")
local VirtualUser = game:GetService("VirtualUser")

-- Ð–Ð´Ñ‘Ð¼ LocalPlayer Ð¸ PlayerGui
local player = Players.LocalPlayer
repeat task.wait() until player
local playerGui = player:WaitForChild("PlayerGui")

-- ÐŸÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ
local character = player.Character or player.CharacterAdded:Wait()
local rootPart = character:WaitForChild("HumanoidRootPart")

local antiFlingEnabled = false
local visitedPositions, isActive, flySpeed, collected = {}, false, 15, 0
local startTime, antiAfkEnabled, autoResetEnabled = 0, false, false

-- ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Character Ð¿Ñ€Ð¸ Ñ€ÐµÑÐ¿Ð°Ð²Ð½Ðµ
player.CharacterAdded:Connect(function(char)
	character = char
	rootPart = char:WaitForChild("HumanoidRootPart")
	visitedPositions = {}
end)

-- Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ GUI
local gui = Instance.new("ScreenGui", playerGui)
gui.Name = "AutoFarmGui"
gui.ResetOnSpawn = false

local frame = Instance.new("Frame", gui)
frame.Size = UDim2.new(0, 220, 0, 330)
frame.Position = UDim2.new(0.5, -110, 0.3, 0)
frame.BackgroundColor3 = Color3.fromRGB(25,25,35)
frame.BorderSizePixel = 0
frame.Active, frame.Draggable = true, true
Instance.new("UICorner", frame).CornerRadius = UDim.new(0,12)
local stroke = Instance.new("UIStroke", frame)
stroke.Color, stroke.Thickness = Color3.fromRGB(255,140,0), 2

-- Ð’ÑÐ¿Ð¾Ð¼Ð¾Ð³Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¸ Ð´Ð»Ñ ÐºÐ½Ð¾Ð¿Ð¾Ðº Ð¸ Ð»ÐµÐ¹Ð±Ð»Ð¾Ð²
local function makeLabel(y, text)
	local lbl = Instance.new("TextLabel", frame)
	lbl.Size = UDim2.new(0,200,0,18)
	lbl.Position = UDim2.new(0.5,-100,0,y)
	lbl.Text = text
	lbl.TextColor3 = Color3.fromRGB(255,140,0)
	lbl.BackgroundTransparency = 1
	lbl.Font = Enum.Font.Gotham
	lbl.TextSize = 12
	lbl.TextXAlignment = Enum.TextXAlignment.Left
	return lbl
end

local function makeButton(y, text)
	local btn = Instance.new("TextButton", frame)
	btn.Size = UDim2.new(0,200,0,24)
	btn.Position = UDim2.new(0.5,-100,0,y)
	btn.Text = text
	btn.BackgroundColor3 = Color3.fromRGB(50,30,70)
	btn.TextColor3 = Color3.fromRGB(255,165,0)
	btn.Font = Enum.Font.GothamBold
	btn.TextSize = 12
	Instance.new("UICorner", btn).CornerRadius = UDim.new(0,6)
	btn.MouseEnter:Connect(function()
		TweenService:Create(btn, TweenInfo.new(0.2), {BackgroundColor3=Color3.fromRGB(120,60,180)}):Play()
	end)
	btn.MouseLeave:Connect(function()
		TweenService:Create(btn, TweenInfo.new(0.2), {BackgroundColor3=Color3.fromRGB(50,30,70)}):Play()
	end)
	return btn
end

-- Ð—Ð°Ð³Ð¾Ð»Ð¾Ð²Ð¾Ðº
local title = Instance.new("TextLabel", frame)
title.Size = UDim2.new(1,-12,0,28)
title.Position = UDim2.new(0,6,0,5)
title.Text = "ðŸŽƒ Fray.rbx || Autofarm"
title.TextColor3 = Color3.fromRGB(255,165,0)
title.BackgroundTransparency = 1
title.Font = Enum.Font.GothamBold
title.TextSize = 16
title.TextXAlignment = Enum.TextXAlignment.Left

local sep = Instance.new("Frame", frame)
sep.Size = UDim2.new(1,-12,0,1)
sep.Position = UDim2.new(0,6,0,35)
sep.BackgroundColor3 = Color3.fromRGB(120,60,180)
sep.BorderSizePixel = 0

-- ÐšÐ½Ð¾Ð¿ÐºÐ¸
local toggleBtn = makeButton(50, "Auto: OFF")
local antiAfkBtn = makeButton(85, "AFK: OFF")
local autoResetBtn = makeButton(120, "AutoReset: OFF")
local speedBtn = makeButton(155, "Speed: 15")
local antiFlingBtn = makeButton(190, "Anti Fling: OFF")
local disableEffectsBtn = makeButton(225, "Disable Effects")

-- Ð›ÐµÐ¹Ð±Ð»Ñ‹
local counterLabel = makeLabel(260, "Candies: 0")
local timerLabel = makeLabel(275, "Time: 0s")
local rateLabel = makeLabel(290, "Rate: 0/h")

-- Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð²Ð¸Ð¶ÐµÐ½Ð¸Ñ Ðº Ð¼Ð¾Ð½ÐµÑ‚Ð°Ð¼
local function flyTo(pos, speed)
	if not rootPart or not rootPart.Parent then return end
	local dist = (pos - rootPart.Position).Magnitude
	local tween = TweenService:Create(rootPart, TweenInfo.new(dist/speed, Enum.EasingStyle.Linear), {CFrame=CFrame.new(pos)})
	tween:Play()
	tween.Completed:Wait()
end

-- Disable Effects
disableEffectsBtn.MouseButton1Click:Connect(function()
	local ToDisable = {Textures=true, VisualEffects=true, Parts=true, Particles=true, Sky=true}
	for _, v in pairs(game:GetDescendants()) do
		if ToDisable.Parts and (v:IsA("Part") or v:IsA("Union") or v:IsA("BasePart")) then
			v.Material = Enum.Material.SmoothPlastic
		end
		if ToDisable.Particles and (v:IsA("ParticleEmitter") or v:IsA("Smoke") or v:IsA("Explosion") or v:IsA("Sparkles") or v:IsA("Fire")) then
			v.Enabled = false
		end
		if ToDisable.VisualEffects and (v:IsA("BloomEffect") or v:IsA("BlurEffect") or v:IsA("DepthOfFieldEffect") or v:IsA("SunRaysEffect")) then
			v.Enabled = false
		end
		if ToDisable.Textures and (v:IsA("Decal") or v:IsA("Texture")) then
			v.Texture = ""
		end
		if ToDisable.Sky and v:IsA("Sky") then
			v.Parent = nil
		end
	end
	print("Effects Disabler: Ð’ÑÐµ Ñ‚ÐµÐºÑÑ‚ÑƒÑ€Ñ‹ Ð¸ ÑÑ„Ñ„ÐµÐºÑ‚Ñ‹ Ð¾Ñ‚ÐºÐ»ÑŽÑ‡ÐµÐ½Ñ‹")
end)

-- Anti-Fling
RunService.Stepped:Connect(function()
	if antiFlingEnabled then
		for _, coPlayer in pairs(Players:GetPlayers()) do
			if coPlayer ~= player and coPlayer.Character then
				local hrp = coPlayer.Character:FindFirstChild("HumanoidRootPart")
				if hrp then hrp.CanCollide = false end
			end
		end
	end
end)

-- AutoFarm
toggleBtn.MouseButton1Click:Connect(function()
	isActive = not isActive
	toggleBtn.Text = isActive and "Auto: ON" or "Auto: OFF"
	toggleBtn.BackgroundColor3 = isActive and Color3.fromRGB(60,150,60) or Color3.fromRGB(50,30,70)
	if not isActive then return end
	collected, startTime, visitedPositions = 0, tick(), {}

	task.spawn(function()
		while isActive do
			local elapsed = tick() - startTime
			timerLabel.Text = "Time: "..math.floor(elapsed).."s"
			local rate = elapsed > 0 and math.floor((collected/elapsed)*3600) or 0
			rateLabel.Text = "Rate: "..rate.."/h"
			task.wait(0.1)
		end
	end)

	task.spawn(function()
		while isActive do
			character = player.Character or player.CharacterAdded:Wait()
			rootPart = character:FindFirstChild("HumanoidRootPart")
			if rootPart then
				local closest, dist = nil, math.huge
				for _, obj in ipairs(workspace:GetDescendants()) do
					if obj:IsA("BasePart") and obj.Name=="Coin_Server" and not visitedPositions[obj] then
						local d = (obj.Position - rootPart.Position).Magnitude
						if d < dist and d < 250 then
							closest, dist = obj, d
						end
					end
				end
				if closest then
					flyTo(closest.Position, flySpeed)
					if closest:IsDescendantOf(workspace) then
						visitedPositions[closest] = true
						collected += 1
						counterLabel.Text = "Candies: "..collected
					end
				end
			end
			-- AutoReset
			if autoResetEnabled and character then
				local mainGui = player:FindFirstChild("PlayerGui") and player.PlayerGui:FindFirstChild("MainGUI")
				local gameGui = mainGui and mainGui:FindFirstChild("Game")
				local coinBags = gameGui and gameGui:FindFirstChild("CoinBags")
				local container = coinBags and coinBags:FindFirstChild("Container")
				local candy = container and container:FindFirstChild("Candy")
				local currencyFrame = candy and candy:FindFirstChild("CurrencyFrame")
				local icon = currencyFrame and currencyFrame:FindFirstChild("Icon")
				local coinTextLabel = icon and icon:FindFirstChild("Coins")
				if coinTextLabel then
					local coins = tonumber(coinTextLabel.Text)
					if coins and coins >= 40 then
						character:BreakJoints()
					end
				end
			end
			task.wait(0.1)
		end
	end)
end)

-- ÐžÑÑ‚Ð°Ð»ÑŒÐ½Ñ‹Ðµ ÐºÐ½Ð¾Ð¿ÐºÐ¸
antiAfkBtn.MouseButton1Click:Connect(function()
	antiAfkEnabled = not antiAfkEnabled
	antiAfkBtn.Text = antiAfkEnabled and "AFK: ON" or "AFK: OFF"
end)

autoResetBtn.MouseButton1Click:Connect(function()
	autoResetEnabled = not autoResetEnabled
	autoResetBtn.Text = autoResetEnabled and "AutoReset: ON" or "AutoReset: OFF"
end)

speedBtn.MouseButton1Click:Connect(function()
	flySpeed += 1
	if flySpeed > 25 then flySpeed = 10
	speedBtn.Text = "Speed: "..flySpeed
end)

antiFlingBtn.MouseButton1Click:Connect(function()
	antiFlingEnabled = not antiFlingEnabled
	antiFlingBtn.Text = antiFlingEnabled and "Anti Fling: ON" or "Anti Fling: OFF"
end)

-- Anti-AFK
player.Idled:Connect(function()
	if antiAfkEnabled then
		VirtualUser:Button2Down(Vector2.new(0,0),workspace.CurrentCamera.CFrame)
		task.wait(1)
		VirtualUser:Button2Up(Vector2.new(0,0),workspace.CurrentCamera.CFrame)
	end
end)
